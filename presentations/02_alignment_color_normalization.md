# 空域对齐与颜色归一化汇报材料

---

## 部分一：详细流程讲稿（可 5–6 分钟展开）

这一部分是空域对齐与颜色归一化的完整讲稿，适合老师追问细节或你需要讲得更深入时使用。

### 1. 任务背景与整体目标

在前一部分中，我们已经用 `DiskMaculaNet` 模型在眼底图像中自动定位了视盘和黄斑中心点。接下来这一步，是利用这些关键点，对所有眼底图做**空域对齐（几何对齐）**和**颜色归一化**。

这样做的动机有两点：

1. 不同病人的眼底图在拍摄时视角、位置、左右翻转可能不同，如果不对齐，后续网络看到的是“同一个结构出现在不同位置”的混乱情况；
2. 不同设备、不同曝光条件导致整体颜色和亮度差异很大，会干扰网络学习结构信息。

因此，我们在整个系统中设计了一个标准化步骤：先通过视盘–黄斑几何关系做空域对齐，再通过参考图的统计特性做颜色归一化，让所有眼底图在“位置”和“颜色”两个层面尽量一致。

### 2. 几何对齐（空域对齐）整体思路

几何对齐的核心代码在 `align_and_normalize.py` 中实现。整体思路可以概括为三步：

1. 选定一张参考眼底图，预测出它的视盘和黄斑中心，作为“标准坐标系”的基准；
2. 对任意一张待对齐图，也预测视盘和黄斑中心，先判断左右是否需要翻转，再通过仿射变换把它的“结构中点”对齐到参考图；
3. 输出的对齐图像尺寸统一、方向统一，为后续任务提供统一的空间坐标。

下面分步骤展开。

### 3. 参考图的预处理与关键点预测

在 `process` 函数中，我们首先加载训练好的视盘–黄斑检测模型，并处理参考图：

1. **加载模型**  
   - 调用 `load_model`，从 `logs/od_fct_model_best.pth` 读取权重，构建 `DiskMaculaNet` 模型并切换到 `eval` 模式；
   - 兼容多卡训练产生的 `module.` 前缀。

2. **读取参考图并预处理**  
   - 默认参考图路径为 `utils/ref_img.jpg`；
   - 调用 `preprocess_image` 对参考图做以下操作：
     - 查看原图的高和宽，如果宽大于高，在上下方向补边；反之在左右方向补边；
     - 将补边后的图像缩放到 `img_size×img_size`，通常是 `256×256`；
     - 调用 `color_normalization`，先把参考图自己也归一化一遍，保证与后续处理方式一致。

3. **预测参考图中的视盘与黄斑中心**  
   - 使用 `predict_coords`，把预处理后的参考图送入 `DiskMaculaNet`；
   - 得到参考图中的 `od_rx, od_ry, fv_rx, fv_ry`；
   - 将视盘中心和黄斑中心的预测坐标分别记为 `target_od` 与 `target_f`，作为几何对齐的目标位置；
   - 同时计算参考图中黄斑相对于视盘的水平方向差 `ref_dx = target_f[0] - target_od[0]`，后面用于判断左右翻转。

通过这一步，我们就固定了一个“黄金标准视角”：在这张参考图上，视盘和黄斑在什么方位、间距和中点位置。

### 4. 对输入图像进行预测与翻转矫正

接下来，对待对齐的图像逐一处理：

1. **输入与预处理**  
   - 待对齐图像默认从 `alignment_demo_input` 目录读取，也可以通过命令行指定 `--images-dir`；
   - 对每一张图调用同样的 `preprocess_image`：
     - 补边成近似正方形；
     - 缩放到 `img_size×img_size`；
     - 做颜色归一化（这一点很关键，保证参考图与待对齐图在颜色空间上有一致性）。

2. **预测视盘和黄斑坐标**  
   - 调用 `predict_coords`，得到当前图像的 `od_x, od_y, fovea_x, fovea_y`；
   - 这四个值是在预处理后的 `img_size×img_size` 坐标系中的位置。

3. **左右翻转矫正**  
   - 在一些拍摄条件下，眼底图会左右颠倒，例如左眼与右眼、或者设备设置不同导致水平翻转；
   - 为了判断是否需要翻转，我们比较“黄斑相对于视盘的水平方向”：
     - 对参考图：`ref_dx = target_f[0] - target_od[0]`；
     - 对当前图：`dx = fovea_x - od_x`；
   - 如果 `ref_dx * dx < 0`，说明两张图中“黄斑在视盘的哪一侧”是相反的，这时我们认为当前图需要水平翻转：
     - 使用 `cv2.flip(img_256, 1)` 对当前图左右翻转；
     - 同时把视盘和黄斑的 x 坐标在 `img_size` 范围内做镜像：`od_x = img_size - 1 - od_x`，`fovea_x = img_size - 1 - fovea_x`。

这一小步实现了“自动判定是否需要左右翻转”的能力，使得所有对齐后的图像在视盘–黄斑的左右关系上与参考图保持一致。

### 5. 平移对齐：基于结构中点的仿射变换

完成翻转矫正后，我们还需要在平移层面把图像对齐到参考图：

1. **计算当前图和参考图的结构中点**  
   - 使用 `compute_similarity_transform` 函数；
   - 对当前图：计算视盘和黄斑中心的中点：
     - `center = ((od_x + fovea_x)/2, (od_y + fovea_y)/2)`；
   - 对参考图：计算对应的目标中点：
     - `target_center = ((target_od[0] + target_f[0])/2, (target_od[1] + target_f[1])/2)`。

2. **构建平移仿射矩阵**  
   - 计算中点之间的偏移量 `shift = target_center - center`；
   - 构造二维仿射矩阵：
     - `[[1, 0, shift_x], [0, 1, shift_y]]`；
   - 这表示只做平移，不缩放、不旋转，保持眼底球形结构的几何比例不变。

3. **应用仿射变换**  
   - 调用 `cv2.warpAffine`，把（可能已经翻转过的）图像平移到新的位置；
   - 输出的图像大小仍为 `img_size×img_size`，超出边界的区域用黑色填充。

平移对齐的结果是：在所有输出图像中，视盘–黄斑的中点都对齐到参考图中对应的位置，从宏观上保证视网膜主结构的空间位置一致。

### 6. 颜色归一化：与参考图对齐的统计变换

在几何对齐之外，我们还做了颜色归一化，这部分的实现位于 `utils.color_normalization` 中。

其核心思想是用一种简单但有效的“均值–标准差归一化”方法，把所有眼底图的颜色分布对齐到参考图。

具体步骤如下：

1. **读取参考图并转为浮点数**  
   - 在函数内部读取 `ref_img.jpg`，转换为 `float32`；
   - 同样将当前待归一化图像转换为 `float32`。

2. **计算当前图像与参考图的通道统计量**  
   - 使用 `cv2.meanStdDev` 分别计算三通道的均值和标准差：
     - 当前图像的 `(test_mean, test_std)`；
     - 参考图的 `(ref_mean, ref_std)`。

3. **逐通道线性变换**  
   - 对于每个颜色通道 `i`，采用如下变换：
     - 先减去当前图像的均值，再除以当前图像的标准差，使该通道变成“零均值、单位方差”；
     - 再乘以参考图的标准差并加上参考图的均值，让变换后的分布与参考图一致；
   - 特殊情况：如果某个通道的标准差为 0（图像在该通道几乎全是一个值），则跳过变换，直接保留原值，避免除零。

4. **裁剪与类型转换**  
   - 将归一化结果裁剪到 `[0, 255]`；
   - 转回 `uint8` 类型，得到归一化后的 BGR 图像。

这样处理后，不同眼底图像在整体亮度、对比度和色调上都接近参考图。配合几何对齐，网络在后续任务中看到的是一批“位置一致、颜色一致”的标准化眼底图。

### 7. 可视化对齐效果

在 `align_and_normalize.py` 的最后，我们对对齐结果进行了可视化展示：

- 从处理过的图像中选出一张原图对应的 `img_256` 和 `aligned`；
- 参考图、原始预处理图、对齐后图像都转换为 RGB 格式，并统一处理背景颜色，使补边区域不显得突兀；
- 使用 `matplotlib` 画出一个三联图：
  - 左：Reference（参考图）；
  - 中：Original（原始预处理图）；
  - 右：Aligned（对齐后的图像）。

这张三联图可以直接拿到 PPT 里展示“对齐前后”的差别。

### 8. 对后续任务的影响

空域对齐与颜色归一化的作用可以概括为三点：

1. **为血管分割提供统一视角**  
   - 血管分割网络在训练时，如果所有图像的视盘位置、黄斑位置大致一致，可以更稳定地学习“在哪些区域血管密度更高/更低”的模式。

2. **为异常检测提供标准背景**  
   - 在做 PCA 异常检测或其他无监督检测时，统一的颜色和几何结构可以减小无关变化，让模型更专注于真正的病灶差异。

3. **提高跨患者/跨设备的鲁棒性**  
   - 通过对齐视盘–黄斑关系和颜色统计，我们在一定程度上消除了不同设备、不同行业标准带来的差异，使模型更具通用性。

---

## 部分二：2–3 分钟精简讲稿

这一部分是可以直接在答辩时照读的版本，控制在 2–3 分钟左右。

---

大家好，接下来我介绍一下我们在项目中做的空域对齐和颜色归一化。

前一部分我们已经用网络自动检测出了每张眼底图的视盘和黄斑中心。基于这些关键点，我们希望把所有病人的眼底图，在“位置”和“颜色”两个层面都标准化，这样后面的血管分割、异常检测看到的就是一批更一致的输入。

**第一部分是空域对齐。**  
整体思路是先选定一张参考眼底图，作为标准视角。我们对这张参考图做预处理，统一到 `256×256` 的尺度，并通过训练好的 `DiskMaculaNet` 预测出它的视盘和黄斑中心坐标，这两个点就定义了一个标准的几何关系。

对于任意一张待对齐图，我们同样先补边、缩放到 `256×256`，再用同一个网络预测视盘和黄斑中心。接下来做两件事：

第一，判断是否需要左右翻转。我们比较参考图和当前图中“黄斑相对视盘”的水平方向，如果两者相反，就对当前图做一次水平翻转，并同步更新预测坐标，这样可以自动矫正左右颠倒的问题。

第二，用仿射变换做平移对齐。我们分别计算当前图和参考图中，视盘和黄斑中心的中点位置，然后构造一个只做平移的仿射矩阵，把当前图的中点平移到参考图的中点上。这样，对齐后的所有眼底图在视网膜主结构的空间位置上是一致的。

**第二部分是颜色归一化。**  
不同相机拍摄的眼底图颜色风格差异很大，所以我们实现了一个基于统计量的颜色归一化函数 `color_normalization`。它的做法是选一张参考眼底图，计算它在三个颜色通道上的均值和标准差；对于每一张输入图，先算出它自己的均值和标准差，再通过线性变换，把它的颜色分布对齐到参考图的分布上。最后把结果裁剪到 `[0, 255]` 并转换回 `uint8`，得到颜色风格更接近参考图的输出。

在代码中，无论是参考图还是待对齐图，在做几何处理时都会调用这个颜色归一化函数。这样就保证了：所有经过对齐模块输出的眼底图，在位置上对齐了视盘–黄斑结构，在颜色上也对齐到了同一个参考风格。

**最后是这一步对后续任务的意义。**  
通过空域对齐和颜色归一化，我们把原本“视盘位置不同、颜色风格各异”的眼底图，统一成了一批标准化的图像。对于后面的血管分割和异常检测模块来说，这相当于减少了很多无关的变化，让网络更关注真正的结构差异和病灶特征，从而提升整体系统的稳定性和鲁棒性。

---

## 部分三：PPT 制作建议

这一部分是针对“空域对齐与颜色归一化”章节的 PPT 设计建议，可以按 2–3 页来做。

### 第 1 页：方法示意与直观对比

- 标题：  
  - `空域对齐与颜色归一化：方法与效果`

- 左侧图片区域（占宽度约 60%）：  
  - 建议做一个 2×2 或 1×2 的对比布局，例如：
    - 上/左：原始未对齐的眼底图若干张小图（可以截取 `alignment_demo_input` 中的原图缩略图）；  
    - 下/右：对应对齐并归一化后的图像（来自 `alignment_demo_output` 目录）。
  - 也可以直接选一对典型样本：
    - 原图：`alignment_demo_input/IDRiD_059.jpg`；  
    - 对齐后：`alignment_demo_output/IDRiD_059.jpg`。

- 右侧文字要点：  
  - `• 动机：不同病人图像视角和颜色差异较大，影响后续算法`  
  - `• 思路：基于视盘–黄斑几何关系做空间对齐，基于参考图统计量做颜色归一化`  
  - `• 目标：得到位置和颜色更加统一的标准化眼底图`

讲解时：指着对比图，先让老师直观感受到“对齐前后”的差别，再引出后续的具体方法。

### 第 2 页：空域对齐流程

- 标题：  
  - `空域对齐：基于视盘–黄斑的仿射变换`

- 图片布局：  
  - 中间画一条简化流程图：
    - `参考图 → 预测视盘/黄斑 → 得到 target_od, target_f`  
    - `输入图 → 预测视盘/黄斑 → 翻转判定 → 平移对齐 → 对齐图`
  - 可以在图中用两个小眼底图图标表示参考图和输入图，用箭头连出“预测坐标”、“翻转”、“平移对齐”这几个步骤。

- 文字要点（放在图下方或右侧）：  
  - `• 参考图中视盘和黄斑中心定义标准几何关系`  
  - `• 比较黄斑相对视盘的左右关系，自动判断是否需要水平翻转`  
  - `• 基于视盘–黄斑中点构造平移仿射矩阵，对齐到统一位置`

讲解时：按流程图的顺序讲“先定标准 → 再判翻转 → 再做平移对齐”，对应精简讲稿中的空域对齐部分。

### 第 3 页：颜色归一化流程（可与第 2 页合并）

- 标题：  
  - `颜色归一化：对齐到参考眼底图风格`

- 左侧图示：  
  - 选取两三张原始颜色差异较大的眼底图，与归一化后的结果做对比；  
  - 可以用 2 行 × 2 列的小格子展示：
    - 上一行：原始图像 1、原始图像 2；  
    - 下一行：对应的归一化结果。

- 右侧文字要点：  
  - `• 选取参考图 ref_img，计算三通道均值和标准差`  
  - `• 对每张输入图按通道进行均值–标准差归一化，对齐到参考图分布`  
  - `• 减小不同设备和曝光条件带来的颜色差异`

如果 PPT 页数有限，也可以将颜色归一化内容合并到上一页，在空域对齐流程图下面画一条简短的颜色归一化流程：  
`输入图 → 计算均值/方差 → 线性变换 → 归一化图像`。

### 第 4 页（可选）：对后续模块的收益

- 标题：  
  - `标准化对后续任务的提升`

- 图片或示意：  
  - 可以放一张后续血管分割或异常检测的结果图，说明对齐和归一化之后，模型表现更加稳定。

- 文字要点：  
  - `• 为血管分割提供统一的视角和背景`  
  - `• 帮助异常检测关注真正的结构差异而不是成像差异`  
  - `• 提高模型在不同患者、不同设备上的鲁棒性`

讲解时：用这页作为本部分的总结，从整体系统角度强调“空域对齐 + 颜色归一化”是一个很关键的前处理环节。

