# 视盘和黄斑中心检测汇报材料

---

## 部分一：详细流程讲稿（可 5–6 分钟展开）

这一部分是比较完整的讲解版本，适合老师追问细节或你需要讲得更深入时使用。

### 1. 任务背景

我们这个项目的第一步，是在眼底彩照中自动定位视盘和黄斑中心，也就是视盘中心点和黄斑凹的位置。

这两个结构的位置非常关键：
- 一方面，它们是后续病灶检测、视网膜配准时的重要参考坐标；
- 另一方面，它们之间的相对几何关系比较稳定，可以用来做图像的对齐和标准化。

所以在整个系统的最前面，我们先做视盘和黄斑中心检测，为后续模块提供稳定的结构基准。

### 2. 数据和标注格式

我们使用的是公开的 IDRiD 眼底数据集，在工程目录中整理成 `dataset/OD_FCT` 这个子数据集，包括 `train` 和 `test` 两部分。

- 每张图像对应一个 ID，例如 `IDRiD_001`。
- 在 `targets.csv` 中，每个 ID 都标注了四个坐标：
  - 视盘中心：`OD_X`, `OD_Y`
  - 黄斑中心：`Fovea_X`, `Fovea_Y`

在代码中，通过 `OD_FCT_Dataset`（`data_modules/od_fct_dataset.py:9`）这个类来读取图像和标注，只保留标注完整的样本。到这一步，任务就被形式化为一个监督学习的回归问题：输入一张眼底图，输出四个关键点坐标。

### 3. 数据预处理流程

从一张原始眼底图像到模型输入，我们依次进行了以下预处理步骤：

#### 3.1 几何预处理：补边成方形并缩放

- 原始眼底图像的长宽往往不一致。
- 在 `OD_FCT_Dataset` 中，我们先判断长宽大小：
  - 如果宽度大于高度：在上下方向补黑边；
  - 如果高度大于宽度：在左右方向补黑边。
- 补完之后，图像变成一个近似正方形，再统一缩放到 `256×256` 的尺寸。

这样做的目的是让所有图像在几何尺寸和比例上统一，便于网络使用固定结构，并保证坐标在不同图像之间具有可比性。

#### 3.2 颜色归一化：对齐到参考图

不同相机、不同设备拍摄的眼底图颜色风格差异较大，会干扰模型学习。

在 `utils.color_normalization` 中，我们实现了基于统计量的颜色归一化：

- 选定一张参考眼底图 `ref_img.jpg`，计算它在 BGR 三个通道上的均值和标准差；
- 对每一张输入图像，同样计算每个通道的均值和标准差；
- 对输入图像逐通道做线性变换，使其分布对齐到参考图的均值和标准差；
- 最后裁剪到 `[0, 255]` 并转回 `uint8`。

这样预处理后，不同病人的图像在整体亮度、对比度和色调上更加一致，模型更容易关注结构信息而不是成像差异。

#### 3.3 坐标同步变换与缩放

原始标注坐标是基于原图尺寸的，而我们对图像做了“补边”和“缩放到 256×256”。

因此，在构造标签张量时，我们做了同样的几何变换：

- 根据补边的方向和宽度，将 `OD_X, OD_Y, Fovea_X, Fovea_Y` 加上相应的偏移量；
- 然后按照 `最大边长 → 256` 的比例统一缩放；
- 得到的是在 `256×256` 坐标系下的四个浮点坐标。

最终，每个样本由一张 `3×256×256` 的图像张量和一个长度为 4 的坐标向量组成。

### 4. 模型结构：DiskMaculaNet

在模型部分，我们设计了一个轻量级的卷积回归网络 `DiskMaculaNet`（`models/od_fct_net.py:5`），结构可以概括为：

1. 多层卷积 + 最大池化
   - 输入：`3×256×256` 彩色图像；
   - 通过 6 层卷积，每层后接 ReLU 激活和 2×2 最大池化；
   - 空间尺寸不断减半，通道数逐渐增加到 512；
   - 最终得到一个小空间尺度但高维的全局特征图。

2. 全连接层回归四个坐标
   - 将最终特征图展平为一维向量；
   - 先经过一个 512 维的全连接层，再通过最后一个全连接层输出 4 个连续值；
   - 这 4 个值直接对应在 `256×256` 坐标系下的 `(OD_X, OD_Y, Fovea_X, Fovea_Y)`。

本质上，这是一个多输出的回归网络，而不是分类网络。

### 5. 训练流程与损失函数

训练脚本在 `train_od_fct.py` 中，主要流程如下：

- 使用 `train` 子集作为训练集，`test` 子集在这里作为验证集；
- 对两个子集都应用同样的预处理和颜色归一化；
- 损失函数选择 `MSELoss`：
  - 对每个样本，计算预测的 four coordinates 与真实坐标的平方误差；
  - 在 batch 上取均值作为 loss。
- 优化器采用 Adam，学习率和其他超参数可以通过命令行配置；
- 可选使用 StepLR 学习率调度，在训练中后期逐渐减小学习率；
- 每个 epoch 结束：
  - 在验证集上评估平均损失；
  - 保存最新模型 `od_fct_model_latest.pth`；
  - 如果验证损失刷新最优，就更新 `od_fct_model_best.pth`。

通过这样的训练过程，模型逐渐学会从全局结构中预测视盘和黄斑中心的相对位置。

### 6. 测试阶段：从输入图像到检测结果

实际“检测”的过程在 `test_od_fct.py` 中完成：

1. 加载最佳模型
   - 从 `logs/od_fct_model_best.pth` 加载权重；
   - 处理可能存在的 `module.` 前缀，兼容多卡训练的状态字典；
   - 将模型切换到 `eval` 模式。

2. 对测试集逐张推理
   - 测试集使用同一个 `OD_FCT_Dataset` 类，保证预处理完全一致；
   - 每张图像经过模型，输出 4 个坐标。

3. 计算误差指标
   - 对视盘中心 `(OD_X, OD_Y)` 和黄斑中心 `(Fovea_X, Fovea_Y)` 分别计算预测值和真实值的欧氏距离；
   - 在整个测试集上取平均，得到视盘和黄斑中心的平均定位误差。

4. 可视化结果
   - 对前若干张测试图，将结果可视化保存到 `results_od_fct` 目录：
     - 用绿色点标出真实视盘和黄斑中心；
     - 用红色点标出预测位置；
     - 在图像左上角叠加文字显示每个点的欧氏距离。

这些图片可以直接放入 PPT，作为定性效果展示。

### 7. 在后续任务中的作用

检测到的视盘和黄斑中心不仅是一个局部任务的输出，还被我们用于后续的图像配准与标准化（`align_and_normalize.py`）：

- 首先在一张参考图上预测视盘和黄斑中心，得到参考几何关系；
- 对任意一张待处理图：
  - 预测其视盘和黄斑中心；
  - 若视盘–黄斑方向与参考图相反，则先水平翻转；
  - 然后根据两个中心点构造相似变换，将中点对齐；
- 最终把不同病人的眼底图对齐到统一视角和位置，为血管分割和异常检测提供统一的坐标系。

---

## 部分二：2–3 分钟精简讲稿

这一部分是可以直接在答辩时照读的版本，控制在 2–3 分钟左右。

---

大家好，下面我介绍一下我们项目中的第一步：眼底图像中视盘和黄斑中心的自动检测。

在眼底彩照里，视盘和黄斑是最重要的两个解剖结构。准确定位这两个点，一方面可以为后续的病灶检测和分级提供坐标参考，另一方面也为图像对齐、归一化打基础。所以我们首先把它们的中心位置自动找出来。

**第一部分是任务和数据。**  
我们使用的是 IDRiD 公开数据集，整理成 OD_FCT 子数据集。每张图像有一个 ID，比如 `IDRiD_001`，在 `targets.csv` 中对应四个标注坐标：视盘中心的 `OD_X, OD_Y`，以及黄斑中心的 `Fovea_X, Fovea_Y`。这样，这个任务就被形式化成：给一张眼底图，回归出四个关键点坐标。

**第二部分是预处理和模型。**  
在预处理阶段，我们主要做了三件事：

第一，几何预处理。原始图像长宽比不一，我们先在较短的一边补黑边，把图像扩展成近似正方形，然后统一缩放到 `256×256`。对应的四个标注坐标也按同样的补边和缩放比例进行变换，保证坐标和图像始终在同一坐标系。

第二，颜色归一化。不同相机拍出的眼底颜色风格差异很大。我们选定一张参考眼底图 `ref_img.jpg`，计算它在三个通道上的均值和方差。对于每张输入图，先算出它自己的均值和方差，再通过线性变换把它的颜色分布拉到和参考图一致，这样可以减小成像条件差异，让模型更关注结构信息。

第三，张量化。预处理后的 `256×256` 彩色图转换为 `3×256×256` 的浮点张量，标注坐标转换为长度为 4 的浮点向量，组成训练样本。

在模型结构上，我们设计了一个轻量级的卷积回归网络 `DiskMaculaNet`。它通过多层卷积加最大池化逐步提取全局特征，把整张眼底图压缩成一个 512 维的深度特征，然后通过全连接层直接回归 4 个连续值，分别对应视盘和黄斑中心在 `256×256` 坐标系下的 `(x, y)`。损失函数使用均方误差，在训练集上不断最小化预测坐标与标注坐标的差距，在验证集上监控平均损失，并保存表现最好的模型权重。

**第三部分是检测和结果。**  
在测试阶段，我们加载训练好的最佳模型，对测试集逐张进行推理。对每张测试图，重复同样的预处理，送入网络得到 4 个预测坐标；然后在像素级别上计算预测点与真实点的欧氏距离，分别统计视盘和黄斑的平均定位误差。

为了直观展示效果，我们把前几张测试图可视化：在同一张图上用绿色点标出真实位置，用红色点标出预测位置，并在图上标注两者的距离。这些结果保存在 `results_od_fct` 目录中，可以直接放到 PPT 里展示。

最后，这个视盘和黄斑中心检测不仅提供了关键的结构坐标，也被我们用在后续的图像对齐和标准化中：通过对齐不同图像的视盘–黄斑几何关系，把所有眼底图归一到统一的视角和位置，为后续血管分割和异常检测打下一个稳定的基础。

---

## 部分三：PPT 制作建议

这一部分是针对 PPT 设计的建议，包含每一页的标题、配图和文字要点。

### 第 1 页：任务与数据（引入）

- 标题：  
  - `视盘和黄斑中心检测：任务与数据`

- 左侧图片（大图，占左 60% 宽度）：  
  - 放一张原始眼底图，例如：
    - `Normal Retinal Images/01_test.tif` 或任意一张代表性的原图；
  - 不用标记点，只展示原始图像，让观众先有直观印象。

- 右侧文字要点（3 条左右）：  
  - `• 目标：自动回归视盘中心和黄斑中心坐标`  
  - `• 数据：IDRiD 公开眼底彩照数据集`  
  - `• 标注：每张图有 OD_X, OD_Y, Fovea_X, Fovea_Y 四个坐标`

讲解时：用这页快速说明“为什么要找这两个点 + 用什么数据 + 标注形式是什么”。

### 第 2 页：预处理与模型（方法总览）

- 标题：  
  - `预处理与模型结构`

- 图片布局建议：
  1. 上方放一条“小流程图”：  
     - `原始图像 → 补黑边成正方形 → 缩放到 256×256 → 颜色归一化`  
     - 每一步用一个矩形 + 箭头表示预处理流水线。
  2. 下方放一个简化网络结构示意图：  
     - 左边是一张小的 `256×256` 图标，接几层“Conv+Pool”方块，最后连到“FC → 4 个坐标”的方块。  
     - 不需要写每一层的具体参数，只强调：多层卷积提特征 → 全连接回归 4 个坐标。

- 右侧文字要点（建议 3 条）：  
  - `• 几何预处理：补黑边成方形，统一缩放到 256×256`  
  - `• 颜色归一化：对齐到参考图 ref_img 的颜色统计`  
  - `• 模型：轻量级卷积网络 DiskMaculaNet，回归 4 个坐标`

讲解时：顺着图，从“图像怎么处理”讲到“网络怎么设计”，对应精简讲稿的第二部分。

### 第 3 页：检测效果与定位误差

- 标题：  
  - `检测效果与定位误差`

- 左侧图片（核心展示）：  
  - 使用测试脚本生成的结果图，例如：
    - `results_od_fct/result_000.jpg` 或 `result_001.jpg` 中效果较好的几张；
  - 图中已经包含：
    - 绿色圆点：真实视盘 / 黄斑中心位置；
    - 红色圆点：模型预测的位置；
    - 左上角的文字：各点的欧氏距离。

- 右侧文字要点：  
  - `• 模型能稳定地逼近真实视盘和黄斑中心`  
  - `• 视盘中心平均误差：XX 像素`  
  - `• 黄斑中心平均误差：XX 像素`  
  - `• 这些坐标将作为后续配准与病灶检测的结构参考`

讲解时：指着绿色/红色点说明“绿色是真实，红色是预测，可以看到大部分点都非常接近”，再报出平均误差数字增强说服力。

### 第 4 页（可选）：对齐和标准化的应用

如果希望把“对齐和归一化”也一并讲在这一部分，可以增加一页。

- 标题：  
  - `基于视盘–黄斑的图像对齐`

- 图片布局：  
  - 左右并排两张图：
    - 左：`alignment_demo_input/IDRiD_059.jpg`（原始图）  
    - 右：`alignment_demo_output/IDRiD_059.jpg`（对齐后的图）

- 下方或右侧文字要点：  
  - `• 利用检测到的视盘和黄斑中心，校正左右翻转`  
  - `• 通过几何变换，把视盘–黄斑连线对齐到统一位置`  
  - `• 为后续血管分割、异常检测提供统一的坐标系`

讲解时：强调这一步是“前处理中的高级操作”，用关键点把不同病人的眼底图对齐到一个规范视角。

