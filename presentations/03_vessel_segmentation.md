# 视网膜血管分割汇报材料

---

## 部分一：详细流程讲稿（可 5–6 分钟展开）

这一部分是血管分割模块的完整讲稿，适合老师追问实现细节或你需要讲得更深入时使用。

### 1. 任务背景与整体目标

在完成视盘和黄斑定位、以及空域对齐和颜色归一化之后，我们的第三个核心任务是**视网膜血管分割**。

眼底图像中的血管网络是很多诊断指标的基础：

- 血管走向和密度与糖网病、视网膜静脉阻塞等疾病高度相关；
- 血管形态和口径变化也是临床医生判断严重程度的重要依据。

因此，我们希望从标准化后的眼底图中，自动分割出一张二值血管掩膜，为后续的异常检测、血管擦除（inpainting）等步骤提供基础。

在实现上，我们把血管分割建模为一个**二分类像素级分割**问题：输入是彩色眼底图，输出是与之同尺寸的单通道概率图，表示每个像素是“血管”还是“背景”的概率。

### 2. 数据集与标注格式

血管分割数据的加载逻辑在 `VesselSegDataset` 中实现（`data_modules/vessel_seg_dataset.py:9`）。

我们整合了多个公开数据集到一个统一的 `dataset/Vessel` 目录下，包括：

- `DRIVE`：经典的视网膜血管分割数据集；
- `HRF`：高分辨率眼底图数据集；
- `AdamHoover`：Hoover 提供的人工标注血管数据。

数据组织方式：

- 在 `training` 子目录中，按数据源分别存放图像和对应的血管标注：
  - 对 DRIVE：  
    - 图像在 `training/DRIVE/images` 中，命名为 `xx_training.tif`；  
    - 掩膜在 `training/DRIVE/targets` 中，命名为 `xx_manual1.gif`。
  - 对 AdamHoover：  
    - 图像在 `training/AdamHoover/images` 中，`.ppm` 格式；  
    - 掩膜在 `training/AdamHoover/targets` 中，命名为 `同名.ah.ppm`。
  - 对 HRF：  
    - 原图在 `training/HRF/images` 中，`.JPG` 格式；  
    - 掩膜在 `training/HRF/targets` 中，命名为 `*_dr.tif`。
- 在 `test` 子目录中，主要使用 DRIVE 的测试划分：
  - 图像在 `test/images` 中，命名为 `xx_test.tif`；
  - 掩膜在 `test/targets` 中，命名为 `xx_manual1.gif`。

在 `VesselSegDataset` 的构造函数中可以指定 `split="train"` 或 `"test"`，并通过 `sources` 参数灵活选择训练时要使用的数据来源。

### 3. 数据预处理流程

在 `__getitem__` 中，每个样本的预处理流程如下：

1. **读取图像与掩膜**  
   - 使用 OpenCV 以 BGR 彩色方式读取原始眼底图像；
   - 读取对应的血管掩膜，如果 OpenCV 无法正确读入 `.gif` 或 `.ppm`，则使用 PIL 转为灰度图再转为 NumPy 数组；
   - 若图像或掩膜读取失败，抛出错误，保证数据质量。

2. **统一尺寸到 256×256**  
   - 图像使用双线性插值缩放到 `img_size=(256, 256)`；
   - 掩膜使用最近邻插值缩放到 `256×256`，避免产生灰度混合，保证二值性质。

3. **归一化与二值化**  
   - 图像像素值从 `[0, 255]` 线性归一化到 `[0, 1]`，便于网络训练；
   - 掩膜通过阈值 `(mask > 0)` 转为 0/1 的浮点数组，表示“血管”与“非血管”。

4. **转为张量并调整通道顺序**  
   - 图像从 `H×W×C` 转为 `C×H×W`，再转换为 `float32` 的 `torch.Tensor`；
   - 掩膜增加一个通道维度，从 `H×W` 转为 `1×H×W` 的张量。

最终，每个样本被打包为 `(img, mask)`，可以直接用于分割网络的训练和评估。

### 4. 模型结构：U-Net 风格的 VesselSegNet

血管分割网络在 `models/vessel_seg_net.py` 中定义，命名为 `VesselSegNet`。整体结构是一个典型的 U-Net 风格编解码器，由对称的编码器和解码器加跳跃连接构成。

1. **基本模块：DoubleConv**  
   - 每个编码和解码阶段使用 `DoubleConv` 模块：
     - 两个连续的 `3×3` 卷积，配合 BatchNorm 和 ReLU；
     - 通过更深的局部感受野和非线性组合，提取更加丰富的特征。

2. **编码器（下采样路径）**  
   - `enc1`: 输入 `3×256×256`，输出 `64×256×256`；
   - `pool1`: 最大池化，尺寸减半到 `64×128×128`；
   - `enc2`: 提取 `128×128×128` 特征；
   - `pool2`: 下采样到 `128×64×64`；
   - `enc3`: 提取 `256×64×64` 特征；
   - `pool3`: 下采样到 `256×32×32`；
   - `bottleneck`: 中间瓶颈层，将特征通道提升到 512，捕获更大范围的上下文信息。

3. **解码器（上采样路径）和跳跃连接**  
   - `up3`: 通过反卷积把瓶颈特征上采样到 `256×64×64`，与编码阶段的 `enc3` 特征拼接，得到 `512×64×64`，再通过 `dec3` 进行两次卷积；
   - `up2`: 上采样到 `128×128×128`，与 `enc2` 的特征拼接，再经 `dec2` 处理；
   - `up1`: 上采样到 `64×256×256`，与 `enc1` 的特征拼接，再经 `dec1` 处理；
   - 这种“编码特征 + 解码特征”的拼接可以保留高分辨率的边缘信息，同时利用深层的语义信息。

4. **输出层**  
   - 最后通过一个 `1×1` 卷积，将通道数压缩到 1，得到 `1×256×256` 的 `logits`；
   - 后续通过 `sigmoid` 转为概率，表示每个像素是血管的置信度。

这种网络结构已经在医学图像分割任务中被证明非常有效，特别适合需要精细边界的血管分割任务。

### 5. 训练流程与损失函数

训练脚本为 `train_vessel_seg.py`，整体流程如下：

1. **数据加载与设备选择**  
   - 从 `dataset/Vessel` 目录初始化训练集和验证集，两者预处理流程一致；
   - 通过命令行参数选择训练轮数、batch size、学习率、图像大小等；
   - 自动检测是否有 GPU，如有则优先使用，并在多卡情况下启用 `DataParallel`。

2. **损失函数与优化器**  
   - 使用 `BCEWithLogitsLoss` 作为像素级二分类损失：
     - 直接接受网络输出的 `logits` 与真实二值掩膜；
     - 内部包含 `sigmoid` 操作，更稳定。
   - 使用 Adam 优化器，支持设置 `weight_decay` 抑制过拟合。

3. **学习率调度**  
   - 可选的 StepLR 调度器：
     - 每隔若干个 epoch，将学习率按给定 `gamma` 进行衰减；
     - 帮助模型在训练后期更稳定地收敛。

4. **训练与评估指标：Dice 系数**  
   - 在每个 epoch 中：
     - 训练阶段：
       - 前向传播得到 logits，计算 BCEWithLogitsLoss；
       - 反向传播更新参数；
       - 同时计算基于预测二值掩膜的 Dice 系数：
         - 用 `sigmoid` 得到概率；
         - 用阈值 0.5 转为二值预测；
         - 统计与真实掩膜的交集和并集，计算每个 batch 的 Dice，取平均作为训练 Dice。
     - 验证阶段：
       - 调用统一的 `evaluate` 函数，在验证集上计算平均损失和平均 Dice。
   - Dice 系数是衡量分割重叠程度的经典指标，数值在 0 到 1 之间，越接近 1 表示预测越接近真实血管分布。

5. **模型保存策略**  
   - 每个 epoch 结束后：
     - 始终保存最新模型到 `vessel_seg_model_latest.pth`；
     - 如果当前验证损失优于历史最优，则更新 `vessel_seg_model_best.pth`，同时打印对应的验证 Dice。

可选地，还可以通过 wandb 记录训练曲线，帮助调参和对比不同配置的效果。

### 6. 测试与可视化结果

在 `test_vessel_seg.py` 中，我们对训练好的血管分割模型进行测试和可视化。

1. **加载测试集与模型**  
   - 从 `dataset/Vessel/test` 加载测试集，统一缩放到 `256×256`；
   - 从 `logs/vessel_seg_model_best.pth` 加载训练最佳模型，同样处理多卡训练产生的 `module.` 前缀；
   - 将模型切换到 `eval` 模式。

2. **逐张推理与 Dice 评估**  
   - 对每一张测试图：
     - 前向传播得到 logits；
     - 通过 `sigmoid` 得到概率图，再以阈值 0.5 转为二值预测掩膜；
     - 与真实掩膜对比，计算 Dice 系数；
   - 在全部测试样本上取平均，得到最终的平均 Dice，作为该模型的总体性能指标。

3. **可视化：原图、真值、预测三联图**  
   - 为了直观展示效果，我们对前 20 张测试图生成三联图，并保存在 `results_vessel_seg` 目录：
     - 原图：原始眼底图（已经缩放和归一化，乘 255 还原）；
     - Ground Truth：在原图上用绿色覆盖真实血管区域；
     - Prediction：在原图上用红色覆盖预测的血管区域；
   - 在三张图上分别标注标题 `Original`、`Ground Truth`、`Prediction`，并将三者水平拼接，便于在 PPT 中直接展示。

通过这些定量和定性结果，我们可以较为全面地说明血管分割模块的效果。

### 7. 血管分割结果在后续步骤中的作用

血管分割不仅是一个独立任务，还直接服务于后续的“血管擦除”与异常检测等模块。

在 `vessel_inpaint.py` 中，我们利用训练好的分割模型，对眼底图中的血管区域进行自动“擦除”和修补：

- 首先加载 `VesselSegNet`，对每张输入图预测血管掩膜；
- 对掩膜可以做一定膨胀，扩大需要去除的区域；
- 使用 OpenCV 的 `inpaint` 算法在血管区域进行图像修补，得到“去血管”的眼底图；
- 同时生成一张三联图：原图、血管预测叠加图、擦除后的图，用于展示分割与擦除效果。

这样的“去血管”操作可以帮助后续的亮斑/出血等病灶检测模块减少血管结构的干扰，更专注于真正的病灶区域。

---

## 部分二：2–3 分钟精简讲稿

这一部分是可以直接在答辩时照读的版本，长度控制在 2–3 分钟左右。

---

大家好，下面我介绍一下我们项目中的第三个模块：视网膜血管分割。

在前面的工作中，我们已经完成了视盘和黄斑定位，以及基于关键点的空域对齐和颜色归一化。接下来，我们希望从这些标准化后的眼底图中，自动分割出血管网络，为后续的血管擦除和异常检测提供基础。

**第一部分是数据和任务形式。**  
我们在 `dataset/Vessel` 目录中整合了多个公开血管分割数据集，包括 DRIVE、HRF 和 AdamHoover。每张图像都对应一张人工标注的血管掩膜。我们把这个问题建模为像素级二分类：给一张彩色眼底图，输出一张同尺寸的单通道概率图，表示每个像素是血管还是背景。

在数据预处理上，我们对所有图像和掩膜统一缩放到 `256×256`。图像用双线性插值并归一化到 `[0, 1]`，掩膜用最近邻插值并阈值化成 0/1 二值图。最终，每个样本就是一对 `(图像张量, 掩膜张量)`。

**第二部分是网络结构和训练。**  
在模型上，我们实现了一个 U-Net 风格的分割网络 `VesselSegNet`。编码器部分通过多层卷积加最大池化逐步下采样，提取越来越抽象的语义特征；解码器部分通过反卷积逐步上采样，并在每一层与编码器的特征做跳跃连接，这样既保留了高层语义，又保留了低层的细节边界。最后通过一个 `1×1` 卷积输出单通道 logits 图，后接 sigmoid 得到每个像素的血管概率。

训练时，我们使用 `BCEWithLogitsLoss` 作为像素级二分类损失，通过 Adam 优化器进行更新。同时，我们用 Dice 系数来评价分割重叠程度：对每个 batch，我们先用 0.5 阈值把概率图变成二值掩膜，再计算与真实掩膜的交集和并集，从而得到 Dice 指标。每个 epoch 后，我们在验证集上统计平均损失和平均 Dice，并保存最优模型。

**第三部分是测试和可视化结果。**  
在测试阶段，我们加载训练好的最佳模型，对测试集逐张推理，计算平均 Dice，作为血管分割总体性能的量化指标。为了更直观地展示效果，我们对前几张测试图生成三联图：左边是原始眼底图，中间是在原图上用绿色覆盖真实血管区域，右边是在原图上用红色覆盖模型预测的血管区域。这些可视化结果保存在 `results_vessel_seg` 目录，可以直接放到 PPT 里展示。

最后，这个血管分割结果还会被用在后续的血管擦除模块中。我们利用预测的血管掩膜，自动把血管区域“挖空”，再用图像修补算法进行填补，得到去血管的眼底图，为后续的病灶检测提供一个干净的背景。这一整条链路，让我们的系统既能感知血管本身，又能在需要的时候把血管对病灶的干扰降到最低。

---

## 部分三：PPT 制作建议

这一部分是针对“血管分割”章节的 PPT 设计建议，可以按 3 页左右来做。

### 第 1 页：任务与数据（引入）

- 标题：  
  - `视网膜血管分割：任务与数据`

- 左侧图片：  
  - 放一张带有明显血管结构的原始眼底图，例如从 `dataset/Vessel/training/DRIVE/images` 中选一张代表性的图像，或者直接用 `results_vessel_seg` 中的某张结果图的“Original”部分裁剪。  

- 右侧文字要点：  
  - `• 目标：从眼底图中自动分割出血管网络`  
  - `• 数据：整合 DRIVE、HRF、AdamHoover 等公开血管分割数据集`  
  - `• 标注：每张图都有对应的二值血管掩膜`

讲解时：简要说明血管为什么重要，以及我们采用了哪些数据集来训练这个模块。

### 第 2 页：方法与网络结构

- 标题：  
  - `血管分割方法：U-Net 风格网络`

- 中间或左侧图示：  
  - 用简化版示意图展示 U-Net 结构：
    - 左侧是一张眼底图图标；  
    - 向右是三四个逐渐缩小的“编码器”方块，标注 `Conv+Pool`；  
    - 再向右是瓶颈层；  
    - 然后是三四个逐渐放大的“解码器”方块，标注 `UpConv + Skip`；  
    - 最右端是一个单通道输出图标，标注 `血管掩膜`。

- 右侧文字要点：  
  - `• 输入：统一缩放到 256×256 的彩色眼底图`  
  - `• 模型：U-Net 风格的编码器–解码器结构，带跳跃连接`  
  - `• 损失与指标：BCEWithLogitsLoss + Dice 系数`

讲解时：重点强调“跳跃连接帮助保留细节边界”“Dice 用来衡量分割重叠程度”，对应精简讲稿的第二部分。

### 第 3 页：分割效果与可视化

- 标题：  
  - `血管分割效果与可视化`

- 图片区域（占据大部分页面）：  
  - 从 `results_vessel_seg` 目录中选几张典型的三联图，比如 `vessel_result_000.jpg`、`vessel_result_001.jpg`；  
  - 每张图内部已经包含：左侧原图，中部真实掩膜覆盖图（绿色），右侧预测掩膜覆盖图（红色）；  
  - 可以直接在 PPT 中放 1–2 张这样的三联图。

- 下方或右侧文字要点：  
  - `• 原图 vs 真实血管 vs 预测血管的直观对比`  
  - `• 平均 Dice ≈ XX（根据你实际实验结果填写）`  
  - `• 预测结果能够较好地覆盖细小血管分支`

讲解时：指着绿色和红色覆盖区域说明预测和真值的重合程度，适当提一句“在极细小血管或边界区域仍有一定误差”，显示你对模型优缺点都有认识。

### 第 4 页（可选）：血管分割在系统中的应用

如果希望在本部分顺带讲“血管擦除”，可以加一页。

- 标题：  
  - `血管分割的应用：血管擦除与异常检测`

- 图片布局：  
  - 使用 `results_vessel_inpaint` 中的一张三联图，比如 `01_test_vessel_inpaint.jpg`：  
    - 左：Original（原图）；  
    - 中：Vessels (Pred)（红色覆盖血管的位置）；  
    - 右：Inpainted（擦除血管后的图像）。

- 文字要点：  
  - `• 利用预测掩膜，自动生成血管区域的 inpaint 掩码`  
  - `• 通过图像修补算法在血管区域进行填补，得到去血管图像`  
  - `• 为后续病灶检测提供更干净的背景，减少血管干扰`

讲解时：用这页把血管分割和下游任务真正“串起来”，让老师看到这个模块在整个系统中的价值，而不仅仅是一张掩膜图。

